# PHP API SDK - "КЛАДР в облаке"

Реализация API для [интеграции с сервисом "ФИАС в облаке"](https://kladr-api.ru/).
Данная SDK поможет быстрее внедрить в ваш проект инструменты взаимодействия с актуальной база всех почтовых адресов России.

---

### Перед началом работы

- Требуется PHP 8.0 или выше.
- Требуется наличие библиотек, реализующих спецификации [PSR-18 (HTTP-client)](https://www.php-fig.org/psr/psr-18/) и [PSR-17 (HTTP Factories)](https://www.php-fig.org/psr/psr-17/).

В SDK применяется спецификации [PSR-18 (HTTP-client)](https://www.php-fig.org/psr/psr-18/) и [PSR-17 (HTTP Factories)](https://www.php-fig.org/psr/psr-17/).
Это значит, что в вашем проекте должны быть установлены и зарегистрированы библиотеки, реализующие эти спецификации (например, [Guzzle](https://github.com/guzzle/guzzle)).

Для автоматического обнаружения зависимостей используются пакеты [psr-discovery](https://github.com/psr-discovery). Подробнее, об [автоматическом обнаружении зависимостей](#автоматическое-обнаружение-зависимостей)

---

### Установка

Установка осуществляется с помощью пакетного менеджера Composer

```shell
composer require webmasterskaya/php-kladr-api
```

---

### Инициализация

Для начала работы, создайте экземпляр клиента

```php
$client = new \Webmasterskaya\Kladr\Client(string $token, array $config => []);
```

**Список параметров:**

- `token` - токен доступа. Опционально. Получить токен доступа, можно [здесь](https://kladr-api.ru/prices). При использовании клиента без токена, подключение будет осуществляться по бесплатному тарифу.
- `config` - массив с параметрами клиента. Опциональное. По-умолчанию - пустой массив. Допустимые поля:
    - `url` - определяет, по какому адресу библиотека будет пытаться подключиться к API

---

### Поиск по всем доступным полям адреса

Для выполнения полнотекстового поиска по всем доступным полям адреса, обратитесь к методу `queryString`

```php
$result = $client->queryString(string $query, array $config = [], int $limit = 10, int $offset = 0);
```

Метод вернёт массив со списком объектов, содержащих поисковую фразу. Подробнее смотрите в разделе "[Ответ сервиса](#ответ-сервиса)"

> **Note**
> Если в $query передать слово "Новгород", то в ответе будут возвращены адреса у которых это слово встречается в названии Региона, Населённого пункта и Улицы

**Список параметров:**

- `query` - строка запроса (что хотите найти?)
- `config` - массив с параметрами запроса. Опциональное. По-умолчанию - пустой массив. Допустимые поля:
    - `withParent` - если установить этот параметр равным 1 или `true`, то в ответ будут включены родительские объекты (для района это регион, для населённого пункта - район и регион и т.п.)
    - `regionId`, `districtId`, `cityId` - идентификатор региона, района и населённого пункта, соответственно. Применяется для ограничения поиска внутри конкретного объекта.
- `limit` - количество результатов в ответе. Опциональное. По-умолчанию - 10. Чтобы вернуть весь список, без ограничения, установите `limit` равным нулю
- `offset` - смещение результатов (для организации постраничной навигации). Опциональное. По-умолчанию - 0

---

### Поиск только по указанному полю адреса

Для выполнения поиска только по указанному полю адреса (например, только в названиях городов), обратитесь к методу `queryField`

```php
$result = $client->queryString(string $query, array $config = [], int $limit = 10, int $offset = 0);
```

Метод вернёт массив со списком объектов, содержащих поисковую фразу, в указанном поле. Подробнее смотрите в разделе "[Ответ сервиса](#ответ-сервиса)"

**Список параметров:**

- `query` - строка запроса (что хотите найти?)
- `config` - массив с параметрами запроса. Обязательное. Допустимые поля:
    - `withParent` - если установить этот параметр равным 1 или `true`, то в ответ будут включены родительские объекты (для района это регион, для населённого пункта - район и регион и т.п.)
    - `regionId`, `districtId`, `cityId`, `streetId`, `buildingId` - идентификатор региона, района, населённого пункта, улицы и строения, соответственно. Применяется для ограничения поиска внутри конкретного объекта.
    - `contentType` - тип объекта (поле), по которому производится поиск. **Обязательное**. [Допустимые типы объектов](#допустимые-типы-объектов)
        - `zip` - почтовый индекс. Работает только при contentType = building.
    - `typeCode` - тип объектов для выдачи. Указывает, какие типы населённых пунктов будут участвовать в поиске. `Code::CITY` - города, `Code::VILLAGE` - сёла, `Code::RURAL` - деревни. Поддерживается битовая комбинация. Например, для
      получения списка только сёл и деревень, передайте `Code::VILLAGE | Code::RURAL`
- `limit` - количество результатов в ответе. Опциональное. По-умолчанию - 10. Чтобы вернуть весь список, без ограничения, установите `limit` равным нулю
- `offset` - смещение результатов (для организации постраничной навигации). Опциональное. По-умолчанию - 0

---

### Допустимые типы объектов

| Константа          | Значение         | Описание                                                        |
|--------------------|------------------|-----------------------------------------------------------------|
| `Content:REGION`   | **_'region'_**   | Осуществлять поиск только по полю "Название региона"            |
| `Content:DISTRICT` | **_'district'_** | Осуществлять поиск только по полю "Название район"              |
| `Content:CITY`     | **_'city'_**     | Осуществлять поиск только по полю "Название населённого пункта" |
| `Content:STREET`   | **_'street'_**   | Осуществлять поиск только по полю "Название улицы"              |
| `Content:BUILDING` | **_'building'_** | Осуществлять поиск только по полю "Номер дома"                  |

---

### Ответ сервиса

---

### Автоматическое обнаружение зависимостей

Ознакомиться со списком автоматически обнаруживаемых библиотек можно по ссылкам ниже:

- [PSR-17 (HTTP Factories)](https://github.com/psr-discovery/http-factory-implementations?tab=readme-ov-file#implementations)
- [PSR-18 (HTTP-client)](https://github.com/psr-discovery/http-client-implementations?tab=readme-ov-file#implementations)

Если в списке автоматического обнаружения нет библиотеки, используемой на вашем проекте, то её нужно зарегистрировать самостоятельно. Подробнее, о [ручной регистрации зависимостей](#ручная-регистрация-зависимостей)

---

### Ручная регистрация зависимостей

#### Пример регистрации HttpClient в Bitrix

```php
\PsrDiscovery\Implementations\Psr18\Clients::add(
    \PsrDiscovery\Entities\CandidateEntity::create(
        'bitrix/main',
        '~23',
        static function (string $class = '\Bitrix\Main\Web\HttpClient') {
            return new $class;
        }
    )
);
```

#### Пример регистрации HttpClient в Joomla

```php
\PsrDiscovery\Implementations\Psr18\Clients::add(
    \PsrDiscovery\Entities\CandidateEntity::create(
        'joomla/http',
        '~3',
        static function (string $class = '\Joomla\Http\Http') {
            return new $class;
        }
    )
);
```

Если у вас в проекте нет библиотек, реализующих PSR-7, то рекомендуем установить максимально лёгкую реализацию [nyholm/psr7](https://github.com/Nyholm/psr7)